# MBPay 支付链接编码生成文档

本文档详细说明如何生成 MBPay 支付链接，包括编码规则、签名算法、示例代码等。

## 目录

- [概述](#概述)
- [支付链接格式](#支付链接格式)
- [编码流程](#编码流程)
- [签名算法](#签名算法)
- [参数说明](#参数说明)
- [完整示例](#完整示例)
- [常见问题](#常见问题)

---

## 概述

支付链接用于生成支付二维码，用户扫码后可以在 MBPay 应用中完成支付。支付链接采用自定义协议格式，包含 Base64 编码的订单信息。

### 使用场景

- 商户网站生成支付二维码
- 移动应用内支付
- 订单支付页面

### 特点

- 支持订单过期时间设置
- 支持异步回调通知
- 包含签名验证，确保数据完整性
- 支持自定义订单号和商品描述

---

## 支付链接格式

### 协议格式

```
mbpay://payorder?data={base64_encoded_json}
```

### 格式说明

- **协议名**：`mbpay://`
- **路径**：`payorder`
- **参数**：`data`，值为 Base64 编码的 JSON 字符串（URL 编码）

### 示例

```
mbpay://payorder?data=eyJhcHBfaWQiOiJ5b3VyX2FwcF9pZCIsImV4cGlyZSI6MTcwNDA2NzIwMCwibm9uY2UiOiJhYmNkZWZnaGlqa2xtbm9wIiwib3JkZXJfbm8iOiJPUkQyMDI1MDEwMTEyMDAwMDEyMzQ1Njc4OTAiLCJhbW91bnQiOjEwMDAsInN1YmplY3QiOiJcdTg1YjVcdTU0NThWUFBcdTRlMDBcdTUxN2MiLCJzaWduIjoiNWY0ZGNjM2I1YWE3NjVkNjFkODMyN2RlYjg4MmNmOTkifQ%3D%3D
```

---

## 编码流程

### 步骤概览

1. **构造订单数据对象**（不含 sign）
2. **生成签名**（sign）
3. **添加签名到数据对象**
4. **转换为 JSON 字符串**
5. **Base64 编码**
6. **URL 编码**
7. **生成支付链接**

### 详细步骤

#### 步骤 1：构造订单数据对象

构造一个包含订单信息的对象（字典/Map），包含以下字段：

```json
{
  "app_id": "your_app_id",
  "expire": 1704067200,
  "nonce": "abcdefghijklmnop",
  "order_no": "ORD202501011200001234567890",
  "amount": 1000,
  "subject": "购买VIP，1个月"
}
```

**注意：** 此时不包含 `sign` 字段。

#### 步骤 2：生成签名

使用签名算法对数据对象进行签名，生成 `sign` 值（详见 [签名算法](#签名算法) 章节）。

#### 步骤 3：添加签名

将 `sign` 添加到数据对象中：

```json
{
  "app_id": "your_app_id",
  "expire": 1704067200,
  "nonce": "abcdefghijklmnop",
  "order_no": "ORD202501011200001234567890",
  "amount": 1000,
  "subject": "购买VIP，1个月",
  "sign": "5f4dcc3b5aa765d61d8327deb882cf99..."
}
```

#### 步骤 4：转换为 JSON 字符串

将数据对象序列化为 JSON 字符串。**支持两种格式**：

**格式 1：紧凑格式（推荐，SDK 默认使用）**
```json
{"app_id":"your_app_id","expire":1704067200,"nonce":"abcdefghijklmnop","order_no":"ORD202501011200001234567890","amount":1000,"subject":"购买VIP，1个月","sign":"5f4dcc3b5aa765d61d8327deb882cf99..."}
```

**格式 2：格式化 JSON（带换行和缩进，pay.html 使用）**
```json
{
  "app_id": "your_app_id",
  "expire": 1704067200,
  "nonce": "abcdefghijklmnop",
  "order_no": "ORD202501011200001234567890",
  "amount": 1000,
  "subject": "购买VIP，1个月",
  "sign": "5f4dcc3b5aa765d61d8327deb882cf99..."
}
```

**注意：** 
- 两种格式都可以使用，系统都能正确解析
- SDK 默认使用紧凑格式（更节省空间）
- pay.html 使用格式化 JSON（便于调试和查看）
- 不转义斜杠（`/`）
- 中文字符使用 UTF-8 编码

#### 步骤 5：Base64 编码

对 JSON 字符串进行 Base64 编码（标准 Base64）：

```
eyJhcHBfaWQiOiJ5b3VyX2FwcF9pZCIsImV4cGlyZSI6MTcwNDA2NzIwMCwibm9uY2UiOiJhYmNkZWZnaGlqa2xtbm9wIiwib3JkZXJfbm8iOiJPUkQyMDI1MDEwMTEyMDAwMDEyMzQ1Njc4OTAiLCJhbW91bnQiOjEwMDAsInN1YmplY3QiOiJcdTg1YjVcdTU0NThWUFBcdTRlMDBcdTUxN2MiLCJzaWduIjoiNWY0ZGNjM2I1YWE3NjVkNjFkODMyN2RlYjg4MmNmOTkifQ==
```

#### 步骤 6：URL 编码

对 Base64 字符串进行 URL 编码（类似 JavaScript 的 `encodeURIComponent`）：

```
eyJhcHBfaWQiOiJ5b3VyX2FwcF9pZCIsImV4cGlyZSI6MTcwNDA2NzIwMCwibm9uY2UiOiJhYmNkZWZnaGlqa2xtbm9wIiwib3JkZXJfbm8iOiJPUkQyMDI1MDEwMTEyMDAwMDEyMzQ1Njc4OTAiLCJhbW91bnQiOjEwMDAsInN1YmplY3QiOiJcdTg1YjVcdTU0NThWUFBcdTRlMDBcdTUxN2MiLCJzaWduIjoiNWY0ZGNjM2I1YWE3NjVkNjFkODMyN2RlYjg4MmNmOTkifQ%3D%3D
```

**注意：** `=` 会被编码为 `%3D`。

#### 步骤 7：生成支付链接

拼接协议格式：

```
mbpay://payorder?data={url_encoded_base64}
```

最终结果：

```
mbpay://payorder?data=eyJhcHBfaWQiOiJ5b3VyX2FwcF9pZCIsImV4cGlyZSI6MTcwNDA2NzIwMCwibm9uY2UiOiJhYmNkZWZnaGlqa2xtbm9wIiwib3JkZXJfbm8iOiJPUkQyMDI1MDEwMTEyMDAwMDEyMzQ1Njc4OTAiLCJhbW91bnQiOjEwMDAsInN1YmplY3QiOiJcdTg1YjVcdTU0NThWUFBcdTRlMDBcdTUxN2MiLCJzaWduIjoiNWY0ZGNjM2I1YWE3NjVkNjFkODMyN2RlYjg4MmNmOTkifQ%3D%3D
```

---

## 签名算法

### 签名规则

支付链接的签名规则与 API 接口签名规则相同：

1. **排除 `sign` 字段**，获取所有其他字段
2. 将所有字段按 **ASCII 升序**排序（键名排序）
3. 将字段拼接为字符串：`k1=v1&k2=v2&...&key=app_secret`
4. 对拼接后的字符串进行 **SHA256** 哈希计算
5. 将哈希结果转换为 **小写 hex** 字符串，作为 `sign` 值

### 签名示例

假设有以下数据对象：

```json
{
  "app_id": "your_app_id_123",
  "expire": 1704067200,
  "nonce": "abcdefghijklmnop",
  "order_no": "ORD202501011200001234567890",
  "amount": 1000,
  "subject": "购买VIP，1个月"
}
```

App Secret 为：`your_app_secret_456`

**步骤 1：** 排除 `sign` 字段，获取字段列表

```
app_id, expire, nonce, order_no, amount, subject
```

**步骤 2：** 按 ASCII 升序排序

```
amount, app_id, expire, nonce, order_no, subject
```

**步骤 3：** 拼接签名字符串

```
amount=1000&app_id=your_app_id_123&expire=1704067200&nonce=abcdefghijklmnop&order_no=ORD202501011200001234567890&subject=购买VIP，1个月&key=your_app_secret_456
```

**步骤 4：** SHA256 哈希

```
SHA256(签名字符串) = 5f4dcc3b5aa765d61d8327deb882cf99...
```

**步骤 5：** 转换为小写 hex 字符串

```
sign = "5f4dcc3b5aa765d61d8327deb882cf99..."
```

### 注意事项

1. **数字类型**：数字需要转换为字符串参与签名
2. **时间戳**：`expire` 是 Unix 时间戳（秒级），需要转换为字符串
3. **中文字符**：中文字符直接参与签名，使用 UTF-8 编码
4. **空值处理**：如果 `notify_url` 为空，不参与签名

---

## 参数说明

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| order_no | string | 是 | 商户订单号（必须唯一） |
| subject | string | 是 | 商品描述（订单标题） |
| amount | int64 | 是 | 订单金额（分，必须大于 0） |
| expire | int64 | 是 | 过期时间（分钟，必须大于 0） |
| nonce | string | 否 | 随机数（可选，不填会自动生成 16 位随机字符串） |
| notify_url | string | 否 | 回调通知地址（可选，支付成功后异步通知） |

### 数据对象字段

支付链接中的数据对象包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| app_id | string | 商户的 App ID（自动添加） |
| expire | int64 | 订单过期时间戳（Unix 时间戳，秒级） |
| nonce | string | 随机数（16 位，用于防重放） |
| order_no | string | 商户订单号 |
| amount | int64 | 订单金额（分） |
| subject | string | 商品描述 |
| notify_url | string | 回调通知地址（可选） |
| sign | string | 签名值 |

### 字段说明

#### expire（过期时间）

- **类型**：Unix 时间戳（秒级）
- **计算方式**：`当前时间戳 + expire（分钟） * 60`
- **示例**：如果当前时间为 `1704067200`，过期时间为 15 分钟，则 `expire = 1704067200 + 15 * 60 = 1704068100`

#### nonce（随机数）

- **类型**：字符串
- **长度**：16 位
- **字符集**：`a-z`、`A-Z`、`0-9`
- **作用**：防止重放攻击
- **生成方式**：如果不提供，SDK 会自动生成

#### amount（订单金额）

- **类型**：整数
- **单位**：分
- **示例**：`1000` 表示 10.00 元

#### subject（商品描述）

- **类型**：字符串
- **限制**：建议不超过 128 个字符
- **编码**：UTF-8

---

## 完整示例

### 示例 1：基本支付链接

**输入参数：**

```json
{
  "order_no": "ORD202501011200001234567890",
  "subject": "购买VIP，1个月",
  "amount": 1000,
  "expire": 15
}
```

**App ID：** `your_app_id_123`  
**App Secret：** `your_app_secret_456`  
**当前时间戳：** `1704067200`

**步骤 1：构造数据对象（不含 sign）**

```json
{
  "app_id": "your_app_id_123",
  "expire": 1704068100,
  "nonce": "abcdefghijklmnop",
  "order_no": "ORD202501011200001234567890",
  "amount": 1000,
  "subject": "购买VIP，1个月"
}
```

**步骤 2：生成签名**

签名字符串：
```
amount=1000&app_id=your_app_id_123&expire=1704068100&nonce=abcdefghijklmnop&order_no=ORD202501011200001234567890&subject=购买VIP，1个月&key=your_app_secret_456
```

签名结果：
```
sign = "5f4dcc3b5aa765d61d8327deb882cf99..."
```

**步骤 3：添加签名**

```json
{
  "app_id": "your_app_id_123",
  "expire": 1704068100,
  "nonce": "abcdefghijklmnop",
  "order_no": "ORD202501011200001234567890",
  "amount": 1000,
  "subject": "购买VIP，1个月",
  "sign": "5f4dcc3b5aa765d61d8327deb882cf99..."
}
```

**步骤 4-7：编码生成链接**

最终支付链接：
```
mbpay://payorder?data=eyJhcHBfaWQiOiJ5b3VyX2FwcF9pZCIsImV4cGlyZSI6MTcwNDA2NzIwMCwibm9uY2UiOiJhYmNkZWZnaGlqa2xtbm9wIiwib3JkZXJfbm8iOiJPUkQyMDI1MDEwMTEyMDAwMDEyMzQ1Njc4OTAiLCJhbW91bnQiOjEwMDAsInN1YmplY3QiOiJcdTg1YjVcdTU0NThWUFBcdTRlMDBcdTUxN2MiLCJzaWduIjoiNWY0ZGNjM2I1YWE3NjVkNjFkODMyN2RlYjg4MmNmOTkifQ%3D%3D
```

### 示例 2：带回调通知的支付链接

**输入参数：**

```json
{
  "order_no": "ORD202501011200001234567890",
  "subject": "购买VIP，1个月",
  "amount": 1000,
  "expire": 15,
  "notify_url": "https://your-domain.com/notify"
}
```

**数据对象（含 notify_url）：**

```json
{
  "app_id": "your_app_id_123",
  "expire": 1704068100,
  "nonce": "abcdefghijklmnop",
  "order_no": "ORD202501011200001234567890",
  "amount": 1000,
  "subject": "购买VIP，1个月",
  "notify_url": "https://your-domain.com/notify",
  "sign": "5f4dcc3b5aa765d61d8327deb882cf99..."
}
```

**注意：** `notify_url` 会参与签名计算。

---

## 常见问题

### Q1: 支付链接中的金额单位是什么？

**A:** 金额单位为**分**，例如 `1000` 表示 10.00 元。

### Q2: 过期时间如何计算？

**A:** 过期时间 = 当前时间戳（秒） + expire（分钟） * 60。例如，如果当前时间为 `1704067200`，过期时间为 15 分钟，则过期时间戳为 `1704068100`。

### Q3: nonce 必须提供吗？

**A:** 是必须的。

### Q4: 支付链接可以重复使用吗？

**A:** 不可以。每个支付链接对应一个订单，订单支付后链接失效。如果需要新的支付，请生成新的链接。

### Q5: 如何验证支付链接的签名？

**A:** 支付链接的签名验证由 MBPay 应用完成。商户只需要确保生成链接时签名正确即可。

### Q6: 支付链接中的中文字符如何处理？

**A:** 中文字符使用 UTF-8 编码，直接参与签名计算。JSON 序列化时保持 UTF-8 编码。

### Q7: Base64 编码后还需要 URL 编码吗？

**A:** 是的。Base64 编码后需要进行 URL 编码（类似 JavaScript 的 `encodeURIComponent`），因为 Base64 字符串可能包含 `+`、`/`、`=` 等特殊字符。

### Q8: 支付链接的长度有限制吗？

**A:** 理论上没有严格限制，但建议：
- `order_no` 不超过 64 个字符
- `subject` 不超过 128 个字符
- `notify_url` 不超过 256 个字符

### Q9: 如何生成支付二维码？

**A:** 使用二维码生成库（如 qrcode.js、zxing 等），将支付链接转换为二维码图片。

### Q10: 支付成功后如何接收通知？

**A:** 如果提供了 `notify_url`，支付成功后会向该地址发送 POST 请求，包含订单信息。请确保回调地址可以接收 POST 请求并验证签名。详见 [回调通知](#回调通知) 章节。

---

## 回调通知

### 概述

当订单支付成功后，如果支付链接中提供了 `notify_url`，系统会向该地址发送异步回调通知。

### 回调时机

- 订单状态变为"支付成功"时立即触发
- 回调失败后，系统会在以下时间间隔重试：5s、5s、15s、30s、60s、120s、300s、600s、1200s、1800s、3600s、7200s
- 可在商户后台查看回调异常信息和状态

### 回调请求

#### 请求方式

```
POST {notify_url}
```

#### 请求头

```
Content-Type: application/x-www-form-urlencoded
```

#### 请求参数

回调请求以 `application/x-www-form-urlencoded` 格式发送，包含以下参数：

| 参数名 | 类型 | 说明 |
|--------|------|------|
| app_id | string | 商户的 App ID |
| order_no | string | 商户订单号 |
| platform_order_no | string | 平台订单号 |
| amount | int64 | 订单金额（分） |
| merchant_amount | int64 | 商户实收金额（分） |
| platform_fee | int64 | 平台手续费（分） |
| subject | string | 商品描述 |
| status | int64 | 订单状态（1=支付成功） |
| paid_at | string | 支付时间（格式：2006-01-02 15:04:05） |
| timestamp | int64 | 时间戳（Unix 时间戳，秒级） |
| sign | string | 签名值 |

#### 回调参数示例

```
app_id=your_app_id&order_no=ORD202501011200001234567890&platform_order_no=202501011200001234567890&amount=1000&merchant_amount=994&platform_fee=6&subject=购买VIP，1个月&status=1&paid_at=2025-01-01 12:00:00&timestamp=1704067200&sign=5f4dcc3b5aa765d61d8327deb882cf99...
```

### 签名验证

**重要：开发者收到回调请求时，必须验证签名，确保请求来自 MBPay 平台。**

#### 验证步骤

1. **获取所有参数**（排除 `sign` 字段）
2. **按 ASCII 升序排序**参数名
3. **拼接签名字符串**：`k1=v1&k2=v2&...&key=app_secret`
   - 格式：`参数名=参数值&参数名=参数值&...&key=app_secret`
   - 注意：最后追加 `&key=app_secret`，其中 `app_secret` 为商户的 App Secret
4. **SHA256 哈希**：对拼接后的字符串进行 SHA256 哈希计算
5. **转换为小写 hex**：将哈希结果转换为小写 hex 字符串
6. **对比签名**：将计算得到的签名与回调请求中的 `sign` 参数对比

#### 验证示例

假设收到以下回调参数：

```
app_id=your_app_id_123
order_no=ORD202501011200001234567890
platform_order_no=202501011200001234567890
amount=1000
merchant_amount=994
platform_fee=6
subject=购买VIP，1个月
status=1
paid_at=2025-01-01 12:00:00
timestamp=1704067200
sign=5f4dcc3b5aa765d61d8327deb882cf99...
```

App Secret 为：`your_app_secret_456`

**步骤 1：** 排除 `sign` 字段，获取参数列表

```
app_id, order_no, platform_order_no, amount, merchant_amount, platform_fee, subject, status, paid_at, timestamp
```

**步骤 2：** 按 ASCII 升序排序

```
amount, app_id, merchant_amount, order_no, paid_at, platform_fee, platform_order_no, status, subject, timestamp
```

**步骤 3：** 拼接签名字符串

```
amount=1000&app_id=your_app_id_123&merchant_amount=994&order_no=ORD202501011200001234567890&paid_at=2025-01-01 12:00:00&platform_fee=6&platform_order_no=202501011200001234567890&status=1&subject=购买VIP，1个月&timestamp=1704067200&key=your_app_secret_456
```

**步骤 4-5：** SHA256 哈希并转换为小写 hex

```
sign = SHA256(签名字符串) 的小写 hex
```

**步骤 6：** 对比签名

```python
if calculated_sign == received_sign:
    # 签名验证通过
    return True
else:
    # 签名验证失败，拒绝处理
    return False
```

### 回调响应

#### 成功响应

开发者验证签名通过后，**必须返回字符串 `"OK"`**（不包含引号，仅返回 OK 两个字符），不需要返回额外的数据信息。

**响应格式：**

```
OK
```

**HTTP 状态码：** `200 OK`

#### 失败响应

如果签名验证失败或处理失败，可以返回其他内容，系统会认为回调失败并进行重试。

### 回调注意事项

1. **必须验证签名**：收到回调请求后，必须验证签名，确保请求来自 MBPay 平台
2. **幂等性处理**：同一个订单可能收到多次回调，需要实现幂等性处理，避免重复处理
3. **快速响应**：回调处理应尽可能快速，建议在 5 秒内返回响应
4. **返回格式**：验证通过后，必须返回字符串 `"OK"`，不要返回 JSON 或其他格式
5. **错误处理**：如果处理失败，可以返回错误信息，系统会进行重试
6. **日志记录**：建议记录回调请求和响应，便于排查问题
7. **HTTPS 回调**：`notify_url` 建议使用 HTTPS 协议，确保数据传输安全

---

## 注意事项

1. **订单号唯一性**：`order_no` 必须在商户维度内唯一
2. **过期时间**：建议设置合理的过期时间（如 15-30 分钟）
3. **签名安全**：确保 App Secret 保密，不要暴露在客户端代码中
4. **HTTPS 回调**：`notify_url` 建议使用 HTTPS 协议
5. **错误处理**：妥善处理生成失败的情况，记录错误日志
6. **测试环境**：在测试环境充分测试后再上线

---

**文档版本**: v1.0  
**最后更新**: 2025-11-11

